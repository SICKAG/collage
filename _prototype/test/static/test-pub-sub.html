<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PubSub Child</title>
</head>

<body>
  <script type="module">
    import { _internal_expose as expose, Observable } from '/bundle/collage.js';
    const services = [
      {
        id: 'languageService',
        version: '0.0.0',
        impl: (method, _args) => {
          switch (method) {
            case 'blubb':
              return ('it works!');
            default:
              return '';
          }
        },
        isSubscribable: true,
        subscriptionTopics: ['languageKey']
      }
    ];
    let subscription;

    let languages = ['de', 'en', 'fr'];
    let count = 0;
    expose(services, [])
      .then((ctx) => {
        document.getElementById("publish").addEventListener('click', () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'publish', ['languageKey', languages[count]])
            .then(() => {
              document.getElementById('response').value = 'published';
              document.getElementById('response').dispatchEvent(new Event('change'));
              count++;
              count = count > 2 ? 0 : count;
            })
            .catch((err) => {
              document.getElementById('response').value = err;
              document.getElementById('response').dispatchEvent(new Event('change'));
            });
        });

        document.getElementById("publishInvalid").addEventListener('click', () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'publish', ['invalidTopic', 'invalid']).then().catch(
            (err) => {
              document.getElementById('response').value = err;
              document.getElementById('response').dispatchEvent(new Event('change'));
            });
        });

        document.getElementById("subscribe").addEventListener('click', async () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'subscribe', ['languageKey'])
            .then((observable) => {
              subscription = observable.subscribe((nextValue) => {
                document.getElementById('langChanged').value = nextValue;
                document.getElementById('langChanged').dispatchEvent(new Event('change'));
              })
            })
            .catch((err) => {
              document.getElementById('langChanged').value = err;
              document.getElementById('langChanged').dispatchEvent(new Event('change'));
            })
        });

        document.getElementById("subscribeInvalid").addEventListener('click', async () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'subscribe', ['invalidTopic']).then().catch(
            (err) => {
              document.getElementById('langChanged').value = err;
              document.getElementById('langChanged').dispatchEvent(new Event('change'));
            }
          );
        });

        document.getElementById("subscribeIsObservable").addEventListener('click', async () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'subscribe', ['languageKey'])
            .then((observable) => {
                document.getElementById('response').value = isObservable(observable);
                document.getElementById('response').dispatchEvent(new Event('change'));
            })
        });

        document.getElementById("unsubObservable").addEventListener('click', () => {
          subscription.unsubscribe();
          document.getElementById('response').value = 'unsubscribed';
          document.getElementById('response').dispatchEvent(new Event('change'));
        });

        document.getElementById("unsubCallService").addEventListener('click', () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'unsubscribe', ['languageKey'])
            .then(() => {
              document.getElementById('response').value = 'unsubscribed';
              document.getElementById('response').dispatchEvent(new Event('change'));
            })
            .catch((err) => {
              document.getElementById('response').value = err;
              document.getElementById('response').dispatchEvent(new Event('change'));
            });
        });

        document.getElementById("unsubscribeInvalid").addEventListener('click', async () => {
          ctx.callService({ id: 'languageService', version: '0.0.0' }, 'unsubscribe', ['invalidTopic']).then().catch(
            (err) => {
              document.getElementById('response').value = err;
              document.getElementById('response').dispatchEvent(new Event('change'));
            }
          );
        });
      });

      function isObservable(obj) {
        return !!obj && (obj instanceof Observable || (typeof obj.subscribe === 'function' && typeof obj.lift === 'function'));
      }
  </script>

  <h2>Pub Sub Child</h2>
  <div id='davinci-mfo-container'></div>
  <button id="unsubObservable">Unsubscribe over observable</button>
  <button id="unsubCallService">Unsubscribe over callService</button>
  <button id="unsubscribeInvalid">Unsubscribe invalid</button>
  <button id="subscribe">Subscribe</button>
  <button id="subscribeInvalid">Subscribe invalid</button>
  <button id="subscribeIsObservable">Subscribe isObservable</button>

  <button id="publish">Set Language</button>
  <button id="publishInvalid">Publish invalid topic</button>
  <input id='langChanged'>
  <input id='response'>

</body>

</html>
